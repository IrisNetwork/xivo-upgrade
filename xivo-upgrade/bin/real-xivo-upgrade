#!/bin/bash

PATH=/bin:/usr/bin:/sbin:/usr/sbin
monit_default="/etc/default/monit"
lib_directory="/usr/share/xivo-upgrade"
upgrading_tool="apt-get"
xivo_service="/usr/bin/xivo-service"

differed_action() {
    local state=$1
    local dir="$lib_directory/$state-upgrade.d"
    echo "executing $state upgrade action"
    for script in $(ls $dir/*); do
        bash $script
    done
}

pre_upgrade() {
    differed_action pre
}

post_upgrade() {
    $xivo_service restart all > /dev/null
    differed_action post
}

get_version() {
    LANG="C"
    xivo_candidate=$(apt-cache policy pf-xivo | grep Candidate | grep -oE '1\.[2-9]\.[0-9]{1,2}')
    xivo_installed=$(apt-cache policy pf-xivo | grep Installed | grep -oE '1\.[2-9]\.[0-9]{1,2}')
    echo "installed version : $xivo_installed"
    echo "proposed update   : $xivo_candidate"
}

upgrading_system() {
    get_version
    if [ $force -eq 0 ]; then
        read -p 'Would you like to upgrade your system (all services will be restarted) [Y/n]? ' answer
        answer="${answer:-Y}"
        if [ "$answer" != 'y' -a "$answer" != 'Y' ]; then
            exit
        fi
    fi
    /sbin/iptables -I INPUT 1 -p udp --dport 5060 -j DROP
    pre_upgrade
    $xivo_service stop
    echo "upgrading xivo"
    $upgrading_tool dist-upgrade -y
    post_upgrade
    $xivo_service restart all
    /sbin/iptables -D INPUT -p udp --dport 5060 -j DROP
}


if [ ! -f /etc/pf-xivo/web-interface/xivo.ini ]; then
    echo "Warning You should run the wizard before using xivo-upgrade"
    exit 1
fi

usage() {
    cat << EOF
    Usage: xivo-upgrade [-d] [-f]
        -d: only download packages
        -f: force yes
EOF
}

while getopts :df opt
do
  case ${opt} in
    d) download_only=1;;
    f) force=1;;
    '?')  echo "${0} : option ${OPTARG} is not valid" >&2
          usage
          exit -1
    ;;
  esac
done
download_only="${download_only:-"0"}"
force="${force:-"0"}"

if [ $download_only -eq 0 ]; then
    upgrading_system
    $xivo_service status
else
    $upgrading_tool -y -d dist-upgrade
fi
