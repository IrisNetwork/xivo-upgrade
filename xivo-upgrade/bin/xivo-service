#!/bin/bash
action=$1
services="postgresql dahdi xivo-confgend pf-xivo-provd pf-xivo-agid asterisk xivo-ctid nginx monit"
reversed_services=$(echo $services | tac -s' ')
monit_default="/etc/default/monit"

usage() {
    cat << EOF
    usage : $0 action
    availables actions :
        status  : print status of all xivo services
        restart : restart all xivo services
        stop    : stop all xivo services
        start   : start all xivo services

    impacted services : $services
EOF
    exit 0
}

xivo_status() {
    echo "checking services"
    for service in $services; do
        if [ $service != "monit" ] ; then
            /etc/init.d/$service status &> /dev/null
            if [ $? -eq 0 ]; then
                echo -e "\tOK\t$service"
            else
                echo -e "\tNOK\t$service"
            fi
        fi
    done
}

disable_monit() {
    sed -i 's/startup=1/startup=0/' $monit_default
}

enable_monit() {
    sed -i 's/startup=0/startup=1/' $monit_default
}

wait_ctid_initialization() {
    cti_initialization=15

    echo "Waiting $cti_initialization seconds before opening port 5060"
    for i in $(seq 1 $cti_initialization); do
        sleep 1
        echo -n '.'
    done
    echo
}

xivo_start() {
    /sbin/iptables -I INPUT 1 -p udp --dport 5060 -j DROP
    enable_monit
    for service in $services; do
        if [ -f /etc/init.d/$service ]; then
            /usr/sbin/invoke-rc.d $service start
        fi
    done
    status=$(asterisk -rx 'core waitfullybooted')

    wait_ctid_initialization

    while [ "$status" != "Asterisk has fully booted." ]; do
        sleep 1
        status=$(asterisk -rx 'core waitfullybooted')
    done
    /sbin/iptables -D INPUT -p udp --dport 5060 -j DROP
}

xivo_stop() {
    /sbin/iptables -I INPUT 1 -p udp --dport 5060 -j DROP
    disable_monit
    for service in $reversed_services; do
        if [ -f /etc/init.d/$service ]; then
            /usr/sbin/invoke-rc.d $service stop
        fi
    done
    /sbin/iptables -D INPUT -p udp --dport 5060 -j DROP
}

xivo_restart() {
    xivo_stop
    xivo_start
}

case $action in
    status)  xivo_status;;
    restart) xivo_restart;;
    start)   xivo_start;;
    stop)    xivo_stop;;
    *) usage;;
esac
