#!/bin/bash
action=$1
services_filter=$2
services="dahdi xivo-confgend pf-xivo-provd pf-xivo-agid asterisk xivo-ctid monit"
monit_default="/etc/default/monit"
no_monit=1
PATH=/bin:/usr/bin:/sbin:/usr/sbin

if [ "$services_filter" = "all" ]; then
    services="postgresql nginx $services"
fi

if [ "$services_filter" = "no_monit" ]; then
    services=$(/bin/echo $services | sed 's/monit//')
    no_monit=0
fi

reversed_services=$(/bin/echo $services | tac -s' ')

usage() {
    cat << EOF
    usage : $0 action [services_filter]
    availables actions :
        status  : print status of all xivo services
        restart : restart all xivo services
        stop    : stop all xivo services
        start   : start all xivo services

    availables services_filter :
        all      : add postgres and nginx to managed services
        no_monit : do not include monit

    impacted services : $services
EOF
    exit 0
}

xivo_status() {
    xivo-check-db
    echo "checking services"
    for service in $services; do
        if [ $service != "monit" ] ; then
            /etc/init.d/$service status &> /dev/null
            if [ $? -eq 0 ]; then
                echo -e "\tOK\t$service"
            else
                echo -e "\tNOK\t$service"
            fi
        fi
    done
}

disable_monit() {
    if [ $no_monit -eq 1 ]; then
        sed -i 's/startup=1/startup=0/' $monit_default
    fi
}

enable_monit() {
    if [ $no_monit -eq 1 ]; then
        sed -i 's/startup=0/startup=1/' $monit_default
    fi
}

wait_ctid_initialization() {
    cti_initialization=15

    grep -q "startup=yes" /etc/default/xivo-ctid
    if [ $? -eq 0 ]; then
        echo "Waiting $cti_initialization seconds before opening port 5060"
        for i in $(seq 1 $cti_initialization); do
            sleep 1
            echo -n '.'
        done
        echo
    fi
}

wait_asterisk_initialization() {
    grep -q RUNASTERISK=yes /etc/default/asterisk
    if [ $? -eq 0 ]; then
        status=$(asterisk -rx 'core waitfullybooted')
        while [ "$status" != "Asterisk has fully booted." ]; do
            sleep 1
            status=$(asterisk -rx 'core waitfullybooted')
        done
    fi
}

xivo_start() {
    /sbin/iptables -I INPUT 1 -p udp --dport 5060 -j DROP
    enable_monit
    for service in $services; do
        if [ -f /etc/init.d/$service ]; then
            /usr/sbin/invoke-rc.d $service start
        fi
    done

    wait_ctid_initialization

    wait_asterisk_initialization

    /sbin/iptables -D INPUT -p udp --dport 5060 -j DROP
}

xivo_stop() {
    /sbin/iptables -I INPUT 1 -p udp --dport 5060 -j DROP
    disable_monit
    for service in $reversed_services; do
        if [ -f /etc/init.d/$service ]; then
            /usr/sbin/invoke-rc.d $service stop
        fi
    done
    /sbin/iptables -D INPUT -p udp --dport 5060 -j DROP
}

xivo_restart() {
    xivo_stop
    xivo_start
}

case $action in
    status)  xivo_status;;
    restart) xivo_restart;;
    start)   xivo_start;;
    stop)    xivo_stop;;
    *) usage;;
esac
